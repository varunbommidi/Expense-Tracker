<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expense Tracker</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Inter (default) and Kalam (for subtitle) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Kalam:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- Lucide Icons (Fixed URL) -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    
    <!-- Custom Styles -->
    <style>
        /* Apply Inter font by default */
        body {
            font-family: 'Inter', sans-serif;
        }
        
        /* Custom font class for the subtitle */
        .font-kalam {
            font-family: 'Kalam', cursive;
        }
        
        /* Custom scrollbar for better aesthetics in dark mode */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1f2937; /* gray-800 */
        }
        ::-webkit-scrollbar-thumb {
            background: #4b5563; /* gray-600 */
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280; /* gray-500 */
        }

        /* Ensure icons are sized correctly */
        .lucide-icon {
            width: 1em;
            height: 1em;
            display: inline-block;
            vertical-align: middle;
        }

        /* Hide number input spinners */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 antialiased">

    <!-- App Container -->
    <div class="container mx-auto max-w-4xl p-4 min-h-screen">
        
        <!-- Header -->
        <header class="text-center my-6">
            <h1 class="text-4xl font-bold text-white">Expense Tracker</h1>
            <h6 class="text-lg text-gray-400 font-kalam">Made by Varun</h6>
        </header>

        <!-- Navigation Tabs -->
        <nav class="flex justify-center space-x-4 sm:space-x-8 mb-6 border-b border-gray-700">
            <button data-tab="home" class="nav-tab text-blue-400 border-b-2 border-blue-400 py-3 px-4 font-medium text-sm sm:text-base">Home</button>
            <button data-tab="transactions" class="nav-tab text-gray-400 hover:text-gray-200 py-3 px-4 font-medium text-sm sm:text-base">Transactions</button>
            <button data-tab="analytics" class="nav-tab text-gray-400 hover:text-gray-200 py-3 px-4 font-medium text-sm sm:text-base">Analytics</button>
            <button data-tab="settings" class="nav-tab text-gray-400 hover:text-gray-200 py-3 px-4 font-medium text-sm sm:text-base">Settings</button>
        </nav>

        <!-- Main Content Area -->
        <main id="main-content">
            
            <!-- Home Tab -->
            <div id="home-content" class="tab-content">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Add Transaction Card -->
                    <div class="bg-gray-800 p-6 rounded-lg shadow-lg flex flex-col items-center justify-center text-center h-48">
                        <h2 class="text-2xl font-semibold mb-4">New Transaction</h2>
                        <button id="open-txn-modal-home" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-300 transform hover:scale-105">
                            Add Expense
                        </button>
                    </div>

                    <!-- Total Spend Card -->
                    <div class="bg-gray-800 p-6 rounded-lg shadow-lg flex flex-col items-center justify-center text-center h-48">
                        <h2 class="text-xl font-semibold text-gray-400 mb-2">Total Spend</h2>
                        <p id="home-total-spend" class="text-4xl font-bold text-red-400">₹0.00</p>
                    </div>
                </div>

                <!-- Payment Method Summary -->
                <div class="mt-8 bg-gray-800 p-6 rounded-lg shadow-lg">
                    <h2 class="text-2xl font-semibold mb-4 text-white">Spend by Payment Method</h2>
                    <div id="home-payment-summary" class="space-y-3">
                        <p class="text-gray-400">No transactions yet.</p>
                        <!-- Summary items will be injected here -->
                    </div>
                </div>
            </div>

            <!-- Transactions Tab -->
            <div id="transactions-content" class="tab-content hidden">
                <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                    <h2 class="text-2xl font-semibold mb-6">Filter Transactions</h2>
                    
                    <!-- Filters -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                        <div>
                            <label for="filter-start-date" class="block text-sm font-medium text-gray-300 mb-1">Start Date</label>
                            <input type="date" id="filter-start-date" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label for="filter-end-date" class="block text-sm font-medium text-gray-300 mb-1">End Date</label>
                            <input type="date" id="filter-end-date" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label for="filter-payment-method" class="block text-sm font-medium text-gray-300 mb-1">Payment Method</label>
                            <select id="filter-payment-method" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="all">All</option>
                                <!-- Options populated by JS -->
                            </select>
                        </div>
                        <div>
                            <label for="filter-person" class="block text-sm font-medium text-gray-300 mb-1">Person</label>
                            <select id="filter-person" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="all">All</option>
                                <!-- Options populated by JS -->
                            </select>
                        </div>
                    </div>
                    <div class="flex justify-start space-x-4 mb-6">
                        <button id="apply-filters" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-5 rounded-lg transition duration-300">Apply</button>
                        <button id="clear-filters" class="bg-gray-600 hover:bg-gray-500 text-white font-medium py-2 px-5 rounded-lg transition duration-300">Clear</button>
                    </div>

                    <!-- Summary Bar -->
                    <div class="flex justify-between items-center bg-gray-700 p-4 rounded-lg mb-6">
                        <h3 class="text-lg font-semibold text-white">Filtered Total</h3>
                        <p id="filtered-total" class="text-2xl font-bold text-red-400">₹0.00</p>
                    </div>

                    <!-- Transactions List -->
                    <h3 class="text-xl font-semibold mb-4">All Transactions</h3>
                    <div id="transactions-list" class="space-y-3 max-h-[50vh] overflow-y-auto pr-2">
                        <p class="text-gray-400 text-center">No transactions found.</p>
                        <!-- Transaction items will be injected here -->
                    </div>
                </div>
            </div>

            <!-- Analytics Tab -->
            <div id="analytics-content" class="tab-content hidden">
                <!-- Total Spend -->
                <div class="bg-gray-800 p-6 rounded-lg shadow-lg mb-6 text-center">
                    <h2 class="text-xl font-semibold text-gray-400 mb-2">Total Spend</h2>
                    <p id="analytics-total-spend" class="text-5xl font-bold text-red-400">₹0.00</p>
                </div>

                <!-- Analytics Sub-Tabs -->
                <div class="flex justify-center space-x-4 mb-6 border-b border-gray-700">
                    <button data-analyticstab="categories" class="analytics-tab text-blue-400 border-b-2 border-blue-400 py-2 px-4 font-medium">By Category</button>
                    <button data-analyticstab="paymentMethods" class="analytics-tab text-gray-400 hover:text-gray-200 py-2 px-4 font-medium">By Payment</button>
                    <button data-analyticstab="people" class="analytics-tab text-gray-400 hover:text-gray-200 py-2 px-4 font-medium">By Person</button>
                </div>

                <!-- Analytics Content Area -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Left Column: Summary List -->
                    <div id="analytics-summary-content" class="bg-gray-800 p-6 rounded-lg shadow-lg">
                        <h3 id="analytics-summary-title" class="text-xl font-semibold mb-4">Spend by Category</h3>
                        <div id="analytics-summary-list" class="space-y-3 max-h-[60vh] overflow-y-auto pr-2">
                            <p class="text-gray-400">No data available.</p>
                            <!-- Summary items injected here -->
                        </div>
                    </div>

                    <!-- Right Column: Transaction Details -->
                    <div id="analytics-details-content" class="bg-gray-800 p-6 rounded-lg shadow-lg">
                        <h3 id="analytics-details-title" class="text-xl font-semibold mb-4">Transactions</h3>
                        <div id="analytics-details-list" class="space-y-3 max-h-[60vh] overflow-y-auto pr-2">
                            <p class="text-gray-400 text-center">Click an item on the left to see transactions.</p>
                            <!-- Transaction details injected here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings Tab -->
            <div id="settings-content" class="tab-content hidden">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    
                    <!-- Manage Categories -->
                    <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                        <h2 class="text-2xl font-semibold mb-4">Categories</h2>
                        <form id="add-category-form" class="flex mb-4">
                            <input type="text" id="new-category-name" class="flex-grow bg-gray-700 border border-gray-600 rounded-l-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="New Category" required>
                            <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-medium px-4 py-2 rounded-r-lg">Add</button>
                        </form>
                        <div id="categories-list" class="space-y-2 max-h-60 overflow-y-auto pr-2">
                            <p class="text-gray-400">No categories added.</p>
                            <!-- Category items injected here -->
                        </div>
                    </div>

                    <!-- Manage Payment Methods -->
                    <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                        <h2 class="text-2xl font-semibold mb-4">Payment Methods</h2>
                        <form id="add-payment-method-form" class="flex mb-4">
                            <input type="text" id="new-payment-method-name" class="flex-grow bg-gray-700 border border-gray-600 rounded-l-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="New Method (e.g., HDFC Card)" required>
                            <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-medium px-4 py-2 rounded-r-lg">Add</button>
                        </form>
                        <div id="payment-methods-list" class="space-y-2 max-h-60 overflow-y-auto pr-2">
                            <p class="text-gray-400">No payment methods added.</p>
                            <!-- Payment method items injected here -->
                        </div>
                    </div>

                    <!-- Manage People -->
                    <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                        <h2 class="text-2xl font-semibold mb-4">People</h2>
                        <form id="add-person-form" class="flex mb-4">
                            <input type="text" id="new-person-name" class="flex-grow bg-gray-700 border border-gray-600 rounded-l-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="New Person" required>
                            <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-medium px-4 py-2 rounded-r-lg">Add</button>
                        </form>
                        <div id="people-list" class="space-y-2 max-h-60 overflow-y-auto pr-2">
                             <p class="text-gray-400">No people added.</p>
                            <!-- People items injected here -->
                        </div>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <!-- Add Transaction Modal -->
    <div id="add-txn-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-gray-800 w-full max-w-md p-6 rounded-lg shadow-xl relative">
            <button id="close-txn-modal" class="absolute top-4 right-4 text-gray-400 hover:text-white">
                <i data-lucide="x" class="lucide-icon"></i>
            </button>
            <h2 class="text-2xl font-semibold mb-6 text-white">Add New Transaction</h2>
            <form id="add-txn-form" class="space-y-4">
                <div>
                    <label for="txn-amount" class="block text-sm font-medium text-gray-300 mb-1">Amount (INR)</label>
                    <input type="number" id="txn-amount" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="0.00" required>
                </div>
                <div>
                    <label for="txn-date" class="block text-sm font-medium text-gray-300 mb-1">Date</label>
                    <input type="date" id="txn-date" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                <div>
                    <label for="txn-category" class="block text-sm font-medium text-gray-300 mb-1">Category</label>
                    <select id="txn-category" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        <option value="">Select Category</option>
                        <!-- Options populated by JS -->
                    </select>
                </div>
                <div>
                    <label for="txn-payment-method" class="block text-sm font-medium text-gray-300 mb-1">Payment Method</label>
                    <select id="txn-payment-method" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        <option value="">Select Method</option>
                        <!-- Options populated by JS -->
                    </select>
                </div>
                <div>
                    <label for="txn-person" class="block text-sm font-medium text-gray-300 mb-1">Person</label>
                    <select id="txn-person" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        <option value="">Select Person</option>
                        <!-- Options populated by JS -->
                    </select>
                </div>
                 <div>
                    <label for="txn-description" class="block text-sm font-medium text-gray-300 mb-1">Description (Optional)</label>
                    <input type="text" id="txn-description" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., Coffee with friends">
                </div>
                <div class="pt-2">
                    <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition duration-300">
                        Save Transaction
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirm-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-gray-800 w-full max-w-sm p-6 rounded-lg shadow-xl">
            <h2 class="text-xl font-semibold mb-4 text-white">Are you sure?</h2>
            <p id="confirm-modal-text" class="text-gray-300 mb-6">This action cannot be undone.</p>
            <div class="flex justify-end space-x-4">
                <button id="confirm-modal-cancel" class="bg-gray-600 hover:bg-gray-500 text-white font-medium py-2 px-5 rounded-lg transition duration-300">Cancel</button>
                <button id="confirm-modal-confirm" class="bg-red-600 hover:bg-red-700 text-white font-medium py-2 px-5 rounded-lg transition duration-300">Delete</button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-10 right-10 bg-green-500 text-white py-3 px-6 rounded-lg shadow-lg hidden z-50 transition-all duration-300 transform translate-y-10 opacity-0">
        <span id="toast-message">Success!</span>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // --- Firebase Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            setDoc, 
            addDoc, 
            deleteDoc, 
            collection, 
            query, 
            where,
            onSnapshot,
            orderBy,
            serverTimestamp,
            writeBatch
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Global State ---
        let db, auth;
        let userId = null;
        let isAuthReady = false;

        let state = {
            categories: [],
            paymentMethods: [],
            people: [],
            transactions: [],
            currentTab: 'home',
            currentAnalyticsTab: 'categories',
            analyticsSelectedItem: null
        };
        
        // --- Firestore Collection References ---
        const getCollectionRef = (collectionName) => {
            if (!userId) throw new Error("User not authenticated");
            return collection(db, `artifacts/${appId}/users/${userId}/${collectionName}`);
        };
        
        const getDocRef = (collectionName, docId) => {
            if (!userId) throw new Error("User not authenticated");
            return doc(db, `artifacts/${appId}/users/${userId}/${collectionName}`, docId);
        };


        // --- App Config (from environment) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- Utility Functions ---
        
        /**
         * Formats a number as INR currency.
         * @param {number} amount - The amount to format.
         * @returns {string} - Formatted currency string.
         */
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-IN', {
                style: 'currency',
                currency: 'INR'
            }).format(amount);
        }
        
        /**
         * Formats a date string (YYYY-MM-DD) to a more readable format.
         * @param {string} dateString - The date string.
         * @returns {string} - Formatted date (e.g., Nov 8, 2025).
         */
        function formatDate(dateString) {
            if (!dateString) return 'Invalid Date';
            const [year, month, day] = dateString.split('-');
            const date = new Date(year, month - 1, day);
            return date.toLocaleDateString('en-IN', {
                day: 'numeric',
                month: 'short',
                year: 'numeric'
            });
        }
        
        /**
         * Shows a toast notification.
         * @param {string} message - The message to display.
         * @param {boolean} [isError=false] - True for error (red), false for success (green).
         */
        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');
            
            toastMessage.textContent = message;
            toast.classList.remove('hidden', 'bg-green-500', 'bg-red-500', 'translate-y-10', 'opacity-0');
            
            if (isError) {
                toast.classList.add('bg-red-500');
            } else {
                toast.classList.add('bg-green-500');
            }
            
            // Animate in
            setTimeout(() => {
                toast.classList.remove('translate-y-10', 'opacity-0');
            }, 10);
            
            // Animate out
            setTimeout(() => {
                toast.classList.add('translate-y-10', 'opacity-0');
                setTimeout(() => toast.classList.add('hidden'), 300);
            }, 3000);
        }

        // --- Modal Handling ---
        
        // Transaction Modal
        const txnModal = document.getElementById('add-txn-modal');
        const openTxnModalButtons = [
            document.getElementById('open-txn-modal-home'),
        ];
        const closeTxnModalButton = document.getElementById('close-txn-modal');
        
        openTxnModalButtons.forEach(btn => btn.addEventListener('click', () => {
            document.getElementById('add-txn-form').reset();
            document.getElementById('txn-date').valueAsDate = new Date(); // Set to today
            txnModal.classList.remove('hidden');
        }));
        
        closeTxnModalButton.addEventListener('click', () => txnModal.classList.add('hidden'));

        // Confirmation Modal
        const confirmModal = document.getElementById('confirm-modal');
        const confirmModalText = document.getElementById('confirm-modal-text');
        const confirmModalCancel = document.getElementById('confirm-modal-cancel');
        const confirmModalConfirm = document.getElementById('confirm-modal-confirm');
        
        let confirmCallback = null;
        
        /**
         * Shows the confirmation modal.
         * @param {string} text - The warning/confirmation text.
         * @param {Function} onConfirm - The function to call if user confirms.
         */
        function showConfirmModal(text, onConfirm) {
            confirmModalText.textContent = text;
            confirmCallback = onConfirm;
            confirmModal.classList.remove('hidden');
        }
        
        confirmModalCancel.addEventListener('click', () => {
            confirmCallback = null;
            confirmModal.classList.add('hidden');
        });
        
        confirmModalConfirm.addEventListener('click', () => {
            if (confirmCallback) {
                confirmCallback();
            }
            confirmCallback = null;
            confirmModal.classList.add('hidden');
        });

        // --- Tab Navigation ---
        const navTabs = document.querySelectorAll('.nav-tab');
        const tabContents = document.querySelectorAll('.tab-content');
        
        navTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const tabName = tab.dataset.tab;
                state.currentTab = tabName;
                
                // Update nav tabs UI
                navTabs.forEach(t => {
                    t.classList.remove('text-blue-400', 'border-blue-400');
                    t.classList.add('text-gray-400');
                });
                tab.classList.add('text-blue-400', 'border-blue-400');
                tab.classList.remove('text-gray-400');
                
                // Show/hide content
                tabContents.forEach(content => {
                    if (content.id === `${tabName}-content`) {
                        content.classList.remove('hidden');
                    } else {
                        content.classList.add('hidden');
                    }
                });

                // Trigger render for the specific tab
                if (tabName === 'home') renderHome();
                if (tabName === 'transactions') renderTransactions();
                if (tabName === 'analytics') renderAnalytics();
                if (tabName === 'settings') renderSettings();
            });
        });

        // --- Analytics Sub-Tab Navigation ---
        const analyticsTabs = document.querySelectorAll('.analytics-tab');
        
        analyticsTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const tabName = tab.dataset.analyticstab;
                state.currentAnalyticsTab = tabName;
                state.analyticsSelectedItem = null; // Clear selection
                
                // Update tabs UI
                analyticsTabs.forEach(t => {
                    t.classList.remove('text-blue-400', 'border-blue-400');
                    t.classList.add('text-gray-400');
                });
                tab.classList.add('text-blue-400', 'border-blue-400');
                tab.classList.remove('text-gray-400');
                
                // Re-render analytics
                renderAnalytics();
            });
        });

        // --- Rendering Functions ---

        /**
         * Main render function to update all dynamic UI parts.
         * Called when data changes.
         */
        function fullRender() {
            // Update dropdowns in all forms
            updateAllDropdowns();
            
            // Re-render the content of the currently active tab
            switch (state.currentTab) {
                case 'home':
                    renderHome();
                    break;
                case 'transactions':
                    renderTransactions(); // This uses filters, so call the filtered version
                    break;
                case 'analytics':
                    renderAnalytics();
                    break;
                case 'settings':
                    renderSettings();
                    break;
            }
        }
        
        /**
         * Renders the Home tab content.
         */
        function renderHome() {
            const { transactions, paymentMethods } = state;
            
            // Total Spend
            const totalSpend = transactions.reduce((sum, txn) => sum + txn.amount, 0);
            document.getElementById('home-total-spend').textContent = formatCurrency(totalSpend);
            
            // Payment Method Summary
            const paymentSummaryEl = document.getElementById('home-payment-summary');
            if (transactions.length === 0) {
                paymentSummaryEl.innerHTML = '<p class="text-gray-400">No transactions yet.</p>';
                return;
            }
            
            const spendByPayment = {};
            transactions.forEach(txn => {
                const name = txn.paymentMethodName || 'Uncategorized';
                spendByPayment[name] = (spendByPayment[name] || 0) + txn.amount;
            });

            if (Object.keys(spendByPayment).length === 0) {
                paymentSummaryEl.innerHTML = '<p class="text-gray-400">No transactions yet.</p>';
                return;
            }

            paymentSummaryEl.innerHTML = Object.entries(spendByPayment)
                .sort(([,a], [,b]) => b - a) // Sort by amount descending
                .map(([name, amount]) => `
                    <div class="flex justify-between items-center bg-gray-700 p-3 rounded-lg">
                        <span class="font-medium text-white">${name}</span>
                        <span class="font-semibold text-red-300">${formatCurrency(amount)}</span>
                    </div>
                `).join('');
        }
        
        /**
         * Renders the Transactions tab content based on filters.
         */
        function renderTransactions() {
            const { transactions } = state;
            
            // Get filter values
            const startDate = document.getElementById('filter-start-date').value;
            const endDate = document.getElementById('filter-end-date').value;
            const paymentMethodId = document.getElementById('filter-payment-method').value;
            const personId = document.getElementById('filter-person').value;

            // Filter transactions
            const filteredTxns = transactions.filter(txn => {
                if (startDate && txn.date < startDate) return false;
                if (endDate && txn.date > endDate) return false;
                if (paymentMethodId !== 'all' && txn.paymentMethodId !== paymentMethodId) return false;
                if (personId !== 'all' && txn.personId !== personId) return false;
                return true;
            });
            
            // Update filtered total
            const filteredTotal = filteredTxns.reduce((sum, txn) => sum + txn.amount, 0);
            document.getElementById('filtered-total').textContent = formatCurrency(filteredTotal);
            
            // Render list
            const listEl = document.getElementById('transactions-list');
            if (filteredTxns.length === 0) {
                listEl.innerHTML = '<p class="text-gray-400 text-center">No transactions found.</p>';
                return;
            }
            
            listEl.innerHTML = filteredTxns
                .sort((a, b) => new Date(b.date) - new Date(a.date)) // Sort by date descending
                .map(txn => createTransactionItemHTML(txn))
                .join('');

            // Add delete listeners to new items
            listEl.querySelectorAll('.delete-txn-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const id = e.currentTarget.dataset.id;
                    showConfirmModal('Are you sure you want to delete this transaction?', () => {
                        deleteTransaction(id);
                    });
                });
            });
        }
        
        /**
         * Renders the Analytics tab content.
         */
        function renderAnalytics() {
            const { transactions } = state;
            
            // Total Spend
            const totalSpend = transactions.reduce((sum, txn) => sum + txn.amount, 0);
            document.getElementById('analytics-total-spend').textContent = formatCurrency(totalSpend);

            let summaryTitle = '';
            let groupBy = '';
            let dataMap = {};

            // 1. Group data based on the active analytics tab
            switch (state.currentAnalyticsTab) {
                case 'categories':
                    summaryTitle = 'Spend by Category';
                    groupBy = 'categoryName';
                    state.categories.forEach(c => dataMap[c.name] = { id: c.id, name: c.name, amount: 0 });
                    break;
                case 'paymentMethods':
                    summaryTitle = 'Spend by Payment Method';
                    groupBy = 'paymentMethodName';
                    state.paymentMethods.forEach(p => dataMap[p.name] = { id: p.id, name: p.name, amount: 0 });
                    break;
                case 'people':
                    summaryTitle = 'Spend by Person';
                    groupBy = 'personName';
                    state.people.forEach(p => dataMap[p.name] = { id: p.id, name: p.name, amount: 0 });
                    break;
            }
            
            transactions.forEach(txn => {
                const key = txn[groupBy] || 'Uncategorized';
                if (dataMap[key]) {
                    dataMap[key].amount += txn.amount;
                } else if (key === 'Uncategorized') {
                    if (!dataMap.Uncategorized) {
                         dataMap.Uncategorized = { id: 'uncategorized', name: 'Uncategorized', amount: 0 };
                    }
                    dataMap.Uncategorized.amount += txn.amount;
                }
            });

            // 2. Render Summary List (Left Side)
            document.getElementById('analytics-summary-title').textContent = summaryTitle;
            const summaryListEl = document.getElementById('analytics-summary-list');
            const summaryData = Object.values(dataMap).filter(item => item.amount > 0);

            if (summaryData.length === 0) {
                summaryListEl.innerHTML = '<p class="text-gray-400 text-center">No data available.</p>';
            } else {
                summaryListEl.innerHTML = summaryData
                    .sort((a, b) => b.amount - a.amount)
                    .map(item => `
                        <div 
                            class="analytics-summary-item flex justify-between items-center p-3 rounded-lg cursor-pointer transition duration-200 ${state.analyticsSelectedItem === item.name ? 'bg-blue-600 text-white' : 'bg-gray-700 hover:bg-gray-600'}"
                            data-name="${item.name}"
                            data-type="${state.currentAnalyticsTab}"
                        >
                            <span class="font-medium">${item.name}</span>
                            <span class="font-semibold">${formatCurrency(item.amount)}</span>
                        </div>
                    `).join('');
            }
            
            // 3. Render Details List (Right Side)
            renderAnalyticsDetails();

            // 4. Add click listeners to summary items
            summaryListEl.querySelectorAll('.analytics-summary-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    state.analyticsSelectedItem = e.currentTarget.dataset.name;
                    // Re-render summary list to show selection
                    analyticsTabs.forEach(t => {
                        if (t.dataset.analyticstab === state.currentAnalyticsTab) {
                            t.click(); // Re-click the active tab to force re-render
                        }
                    });
                    // Re-render details
                    renderAnalyticsDetails();
                });
            });
        }
        
        /**
         * Renders the details list in the Analytics tab.
         */
        function renderAnalyticsDetails() {
            const detailsListEl = document.getElementById('analytics-details-list');
            const detailsTitleEl = document.getElementById('analytics-details-title');

            if (!state.analyticsSelectedItem) {
                detailsTitleEl.textContent = 'Transactions';
                detailsListEl.innerHTML = '<p class="text-gray-400 text-center">Click an item on the left to see transactions.</p>';
                return;
            }
            
            detailsTitleEl.textContent = `Transactions for ${state.analyticsSelectedItem}`;
            
            let keyField = '';
            switch (state.currentAnalyticsTab) {
                case 'categories': keyField = 'categoryName'; break;
                case 'paymentMethods': keyField = 'paymentMethodName'; break;
                case 'people': keyField = 'personName'; break;
            }

            const detailedTxns = state.transactions.filter(txn => {
                const key = txn[keyField] || 'Uncategorized';
                return key === state.analyticsSelectedItem;
            });
            
            if (detailedTxns.length === 0) {
                detailsListEl.innerHTML = '<p class="text-gray-400 text-center">No transactions found for this item.</p>';
                return;
            }
            
            detailsListEl.innerHTML = detailedTxns
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .map(txn => createTransactionItemHTML(txn, false)) // Simple version, no delete
                .join('');
        }

        /**
         * Renders the Settings tab content.
         */
        function renderSettings() {
            renderSettingsList('categories', 'categories-list', 'Category');
            renderSettingsList('paymentMethods', 'payment-methods-list', 'Payment Method');
            renderSettingsList('people', 'people-list', 'Person');
        }
        
        /**
         * Helper to render a list in the Settings tab.
         * @param {'categories'|'paymentMethods'|'people'} stateKey - Key in the global state.
         * @param {string} listElId - ID of the list element in HTML.
         * @param {string} itemType - Singular name (e.g., "Category").
         */
        function renderSettingsList(stateKey, listElId, itemType) {
            const listEl = document.getElementById(listElId);
            const items = state[stateKey];
            
            if (items.length === 0) {
                listEl.innerHTML = `<p class="text-gray-400">No ${itemType.toLowerCase()}s added.</p>`;
                return;
            }
            
            listEl.innerHTML = items.map(item => `
                <div class="flex justify-between items-center bg-gray-700 p-2.5 rounded-lg">
                    <span class="text-white">${item.name}</span>
                    <button class="delete-setting-btn text-red-400 hover:text-red-300" data-id="${item.id}" data-type="${stateKey}" data-name="${item.name}">
                        <i data-lucide="trash-2" class="lucide-icon w-4 h-4"></i>
                    </button>
                </div>
            `).join('');

            // Add delete listeners
            listEl.querySelectorAll('.delete-setting-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const { id, type, name } = e.currentTarget.dataset;
                    
                    // Check if this item is used in any transactions
                    let isUsed = false;
                    let usageField = '';
                    switch (type) {
                        case 'categories': usageField = 'categoryId'; break;
                        case 'paymentMethods': usageField = 'paymentMethodId'; break;
                        case 'people': usageField = 'personId'; break;
                    }
                    
                    isUsed = state.transactions.some(txn => txn[usageField] === id);
                    
                    if (isUsed) {
                        showToast(`Cannot delete "${name}". It is used in transactions.`, true);
                    } else {
                        showConfirmModal(`Delete "${name}"? This cannot be undone.`, () => {
                            deleteSettingItem(type, id);
                        });
                    }
                });
            });
            
            // Re-render lucide icons
            lucide.createIcons();
        }

        /**
         * Updates all dropdown/select elements in the app.
         */
        function updateAllDropdowns() {
            const { categories, paymentMethods, people } = state;
            
            // Transaction Modal Dropdowns
            populateDropdown('txn-category', categories, 'Select Category');
            populateDropdown('txn-payment-method', paymentMethods, 'Select Method');
            populateDropdown('txn-person', people, 'Select Person');
            
            // Transaction Filter Dropdowns
            populateDropdown('filter-payment-method', paymentMethods, 'All', 'all');
            populateDropdown('filter-person', people, 'All', 'all');
        }
        
        /**
         * Helper to populate a <select> element.
         * @param {string} selectId - ID of the select element.
         * @param {Array} items - Array of items (must have id and name).
         * @param {string} defaultOptionText - Text for the default disabled option.
         * @param {string|null} [allOptionValue=null] - Value for an "All" option (e.g., 'all').
         */
        function populateDropdown(selectId, items, defaultOptionText, allOptionValue = null) {
            const selectEl = document.getElementById(selectId);
            if (!selectEl) return;
            
            // Preserve current value if it's a filter
            const currentValue = selectEl.value;
            
            selectEl.innerHTML = ''; // Clear old options
            
            if (allOptionValue !== null) {
                const allOption = document.createElement('option');
                allOption.value = allOptionValue;
                allOption.textContent = defaultOptionText;
                selectEl.appendChild(allOption);
            } else {
                 const defaultOption = document.createElement('option');
                 defaultOption.value = '';
                 defaultOption.textContent = defaultOptionText;
                 defaultOption.disabled = true;
                 selectEl.appendChild(defaultOption);
            }

            items.forEach(item => {
                const option = document.createElement('option');
                option.value = item.id;
                option.textContent = item.name;
                selectEl.appendChild(option);
            });
            
            // Restore previous value if it still exists
            if (selectEl.querySelector(`option[value="${currentValue}"]`)) {
                 selectEl.value = currentValue;
            } else if(allOptionValue !== null) {
                 selectEl.value = allOptionValue; // Default to "All"
            } else {
                 selectEl.value = ''; // Default to placeholder
            }
        }
        
        /**
         * Generates HTML for a single transaction item.
         * @param {object} txn - The transaction object.
         * @param {boolean} [showDelete=true] - Whether to show the delete button.
         * @returns {string} - HTML string.
         */
        function createTransactionItemHTML(txn, showDelete = true) {
            return `
                <div class="bg-gray-700 p-4 rounded-lg flex items-start space-x-4">
                    <div class="flex-shrink-0 bg-gray-600 w-12 h-12 rounded-lg flex items-center justify-center">
                        <span class="text-xl font-bold">${formatDate(txn.date).split(' ')[0]}</span>
                    </div>
                    <div class="flex-grow">
                        <div class="flex justify-between items-center">
                            <span class="font-semibold text-lg text-white">${txn.categoryName || 'N/A'}</span>
                            <span class="font-bold text-xl text-red-300">${formatCurrency(txn.amount)}</span>
                        </div>
                        <p class="text-sm text-gray-300">${txn.description || 'No description'}</p>
                        <div class="text-xs text-gray-400 mt-2 flex flex-wrap gap-x-3 gap-y-1">
                            <span><i data-lucide="calendar" class="lucide-icon w-3 h-3 mr-1"></i>${formatDate(txn.date)}</span>
                            <span><i data-lucide="credit-card" class="lucide-icon w-3 h-3 mr-1"></i>${txn.paymentMethodName || 'N/A'}</span>
                            <span><i data-lucide="user" class="lucide-icon w-3 h-3 mr-1"></i>${txn.personName || 'N/A'}</span>
                        </div>
                    </div>
                    ${showDelete ? `
                    <div class="flex-shrink-0">
                        <button class="delete-txn-btn text-gray-400 hover:text-red-400" data-id="${txn.id}">
                            <i data-lucide="trash-2" class="lucide-icon w-5 h-5"></i>
                        </button>
                    </div>
                    ` : ''}
                </div>
            `;
        }

        // --- Firestore Data Listeners (Real-time) ---

        /**
         * Sets up real-time listeners for all data.
         * Must be called after auth is ready and userId is set.
         */
        function setupDataListeners() {
            if (!isAuthReady || !userId) return;
            
            // Categories Listener
            onSnapshot(getCollectionRef('categories'), (snapshot) => {
                state.categories = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                fullRender();
            }, (error) => console.error("Error fetching categories:", error));
            
            // Payment Methods Listener
            onSnapshot(getCollectionRef('paymentMethods'), (snapshot) => {
                state.paymentMethods = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                fullRender();
            }, (error) => console.error("Error fetching payment methods:", error));
            
            // People Listener
            onSnapshot(getCollectionRef('people'), (snapshot) => {
                state.people = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                fullRender();
            }, (error) => console.error("Error fetching people:", error));
            
            // Transactions Listener
            const transactionsQuery = query(getCollectionRef('transactions'), orderBy('date', 'desc'));
            onSnapshot(transactionsQuery, (snapshot) => {
                state.transactions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                fullRender();
            }, (error) => console.error("Error fetching transactions:", error));
        }

        // --- Firestore CRUD Functions ---
        
        // Add Transaction
        document.getElementById('add-txn-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const amount = parseFloat(document.getElementById('txn-amount').value);
            const date = document.getElementById('txn-date').value;
            const categoryId = document.getElementById('txn-category').value;
            const paymentMethodId = document.getElementById('txn-payment-method').value;
            const personId = document.getElementById('txn-person').value;
            const description = document.getElementById('txn-description').value;
            
            if (!amount || !date || !categoryId || !paymentMethodId || !personId) {
                showToast('Please fill out all required fields.', true);
                return;
            }
            
            // Get names for denormalization
            const categoryName = state.categories.find(c => c.id === categoryId)?.name;
            const paymentMethodName = state.paymentMethods.find(p => p.id === paymentMethodId)?.name;
            const personName = state.people.find(p => p.id === personId)?.name;

            try {
                await addDoc(getCollectionRef('transactions'), {
                    amount,
                    date,
                    categoryId,
                    paymentMethodId,
                    personId,
                    description: description || '',
                    categoryName,
                    paymentMethodName,
                    personName,
                    createdAt: serverTimestamp()
                });
                
                showToast('Transaction added successfully!');
                txnModal.classList.add('hidden');
                e.target.reset();
            } catch (error) {
                console.error("Error adding transaction:", error);
                showToast('Failed to add transaction.', true);
            }
        });

        // Delete Transaction
        async function deleteTransaction(id) {
            try {
                await deleteDoc(getDocRef('transactions', id));
                showToast('Transaction deleted.');
            } catch (error) {
                console.error("Error deleting transaction:", error);
                showToast('Failed to delete transaction.', true);
            }
        }

        // Add Setting Item (Category, Payment Method, Person)
        document.getElementById('add-category-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const input = document.getElementById('new-category-name');
            addSettingItem('categories', input.value.trim());
            input.value = '';
        });
        
        document.getElementById('add-payment-method-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const input = document.getElementById('new-payment-method-name');
            addSettingItem('paymentMethods', input.value.trim());
            input.value = '';
        });
        
        document.getElementById('add-person-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const input = document.getElementById('new-person-name');
            addSettingItem('people', input.value.trim());
            input.value = '';
        });

        async function addSettingItem(collectionName, name) {
            if (!name) return;
            
            // Check for duplicates (case-insensitive)
            const exists = state[collectionName].some(item => item.name.toLowerCase() === name.toLowerCase());
            if (exists) {
                showToast(`"${name}" already exists.`, true);
                return;
            }
            
            try {
                await addDoc(getCollectionRef(collectionName), { name });
                showToast(`${collectionName.slice(0, -1)} added!`);
            } catch (error) {
                console.error(`Error adding ${collectionName}:`, error);
                showToast('Failed to add item.', true);
            }
        }

        // Delete Setting Item
        async function deleteSettingItem(collectionName, id) {
            try {
                await deleteDoc(getDocRef(collectionName, id));
                showToast(`${collectionName.slice(0, -1)} deleted.`);
            } catch (error) {
                console.error(`Error deleting ${collectionName}:`, error);
                showToast('Failed to delete item.', true);
            }
        }

        // --- Filter Event Listeners ---
        document.getElementById('apply-filters').addEventListener('click', renderTransactions);
        document.getElementById('clear-filters').addEventListener('click', () => {
            document.getElementById('filter-start-date').value = '';
            document.getElementById('filter-end-date').value = '';
            document.getElementById('filter-payment-method').value = 'all';
            document.getElementById('filter-person').value = 'all';
            renderTransactions();
        });


        // --- App Initialization ---
        
        /**
         * Initializes the Firebase app and authentication.
         */
        async function initialize() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Set up auth state listener
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true;
                        console.log('User authenticated. UID:', userId);
                        // Once authenticated, set up data listeners
                        setupDataListeners();
                    } else {
                        userId = null;
                        isAuthReady = false;
                        console.log('User signed out.');
                    }
                });

                // Sign in
                if (initialAuthToken) {
                    console.log('Signing in with custom token...');
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    console.log('Signing in anonymously...');
                    await signInAnonymously(auth);
                }
                
                // Set today's date in txn modal
                document.getElementById('txn-date').valueAsDate = new Date();
                
                // Initialize Lucide icons
                lucide.createIcons();

            } catch (error) {
                console.error("Firebase initialization error:", error);
                document.getElementById('main-content').innerHTML = `
                    <div class="text-center p-8 bg-red-800 rounded-lg">
                        <h2 class="text-2xl font-bold mb-2">Application Error</h2>
                        <p>Could not connect to the database. Please check your configuration.</p>
                        <p class="text-sm text-red-200 mt-4">${error.message}</p>
                    </div>
                `;
            }
        }

        // Start the app on window load
        window.onload = initialize;

    </script>
</body>
</html>